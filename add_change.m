% function [f1,f2,f3,pvn,gtn,ban,ac,spvz,sgtz,sge,object]=add_change(y)
k=96;
y=0.5;
a=1;
b=0.5;

%datapv是单位kw光伏板的功率
datapv=[0.00 
0.00 
0.00 
0.00 
0.00 
0.00 
0.00 
0.06 
0.18 
0.29 
0.37 
0.42 
0.44 
0.40 
0.33 
0.23 
0.11 
0.01 
0.00 
0.00 
0.00 
0.00 
0.00 
0.00 
0.00 
0.00 
0.00 
0.00 
0.00 
0.02 
0.13 
0.25 
0.38 
0.50 
0.59 
0.63 
0.61 
0.56 
0.47 
0.34 
0.21 
0.10 
0.01 
0.00 
0.00 
0.00 
0.00 
0.00 
0.00 
0.00 
0.00 
0.00 
0.00 
0.01 
0.10 
0.23 
0.36 
0.47 
0.55 
0.58 
0.56 
0.52 
0.44 
0.33 
0.21 
0.09 
0.01 
0.00 
0.00 
0.00 
0.00 
0.00 
0.00 
0.00 
0.00 
0.00 
0.00 
0.00 
0.01 
0.10 
0.22 
0.32 
0.39 
0.42 
0.40 
0.35 
0.26 
0.15 
0.04 
0.00 
0.00 
0.00 
0.00 
0.00 
0.00 
0.00];

%data1是每小时用电需求GW
data1=[22.4488704
21.32642688
20.20398336
20.76520512
21.88764864
24.13253568
26.37742272
29.18353152
35.91819264
56.122176
52.75484544
44.8977408
42.65285376
44.8977408
40.96918848
31.98964032
29.18353152
26.93864448
29.18353152
28.061088
26.93864448
25.81620096
23.57131392
22.4488704
40.178376
38.1694572
36.1605384
37.1649978
39.1739166
43.1917542
47.2095918
52.2318888
64.2854016
100.44594
94.4191836
80.356752
76.3389144
80.356752
73.3255362
57.2541858
52.2318888
48.2140512
52.2318888
50.22297
48.2140512
46.2051324
42.1872948
40.178376
19.5152112
18.53945064
17.56369008
18.05157036
19.02733092
20.97885204
22.93037316
25.36977456
31.22433792
48.788028
45.86074632
39.0304224
37.07890128
39.0304224
35.61526044
27.80917596
25.36977456
23.41825344
25.36977456
24.394014
23.41825344
22.44249288
20.49097176
19.5152112
12.75504
12.117288
11.479536
11.798412
12.436164
13.711668
14.987172
16.581552
20.408064
31.8876
29.974344
25.51008
24.234576
25.51008
23.277948
18.175932
16.581552
15.306048
16.581552
15.9438
15.306048
14.668296
13.392792
12.75504];

%data2是购电电价
data2=[0.2289
0.2289
0.2289
0.2289
0.2289
0.2289
0.2289
0.2289
0.9647
0.9647
0.9647
0.9647
0.5568
0.5568
0.5568
0.5568
0.5568
0.9647
0.9647
0.9647
0.9647
0.5568
0.5568
0.5568
0.2289
0.2289
0.2289
0.2289
0.2289
0.2289
0.2289
0.2289
0.9647
0.9647
0.9647
0.9647
0.5568
0.5568
0.5568
0.5568
0.5568
0.9647
0.9647
0.9647
0.9647
0.5568
0.5568
0.5568
0.2289
0.2289
0.2289
0.2289
0.2289
0.2289
0.2289
0.2289
0.9647
0.9647
0.9647
0.9647
0.5568
0.5568
0.5568
0.5568
0.5568
0.9647
0.9647
0.9647
0.9647
0.5568
0.5568
0.5568
0.2289
0.2289
0.2289
0.2289
0.2289
0.2289
0.2289
0.2289
0.9647
0.9647
0.9647
0.9647
0.5568
0.5568
0.5568
0.5568
0.5568
0.9647
0.9647
0.9647
0.9647
0.5568
0.5568
0.5568];

%改24小时用电排列
data3=[22.4488704	40.178376	19.5152112	12.75504
21.32642688	38.1694572	18.53945064	12.117288
20.20398336	36.1605384	17.56369008	11.479536
20.76520512	37.1649978	18.05157036	11.798412
21.88764864	39.1739166	19.02733092	12.436164
24.13253568	43.1917542	20.97885204	13.711668
26.37742272	47.2095918	22.93037316	14.987172
29.18353152	52.2318888	25.36977456	16.581552
35.91819264	64.2854016	31.22433792	20.408064
56.122176	100.44594	48.788028	31.8876
52.75484544	94.4191836	45.86074632	29.974344
44.8977408	80.356752	39.0304224	25.51008
42.65285376	76.3389144	37.07890128	24.234576
44.8977408	80.356752	39.0304224	25.51008
40.96918848	73.3255362	35.61526044	23.277948
31.98964032	57.2541858	27.80917596	18.175932
29.18353152	52.2318888	25.36977456	16.581552
26.93864448	48.2140512	23.41825344	15.306048
29.18353152	52.2318888	25.36977456	16.581552
28.061088	50.22297	24.394014	15.9438
26.93864448	48.2140512	23.41825344	15.306048
25.81620096	46.2051324	22.44249288	14.668296
23.57131392	42.1872948	20.49097176	13.392792
22.4488704	40.178376	19.5152112	12.75504
22.4488704	40.178376	19.5152112	12.75504
21.32642688	38.1694572	18.53945064	12.117288];

%安装光伏，燃气，储能的数量
pvn=intvar(1,1,'full');
gtn=intvar(1,1,'full');
ban=intvar(1,1,'full');

%购电的数量
ge=sdpvar(k,1,'full');
%燃气轮机开启产生的发电量
gtz=sdpvar(k,1,'full');
gtz(1,1)=0;
gtz(25,1)=0;
gtz(49,1)=0;
gtz(73,1)=0;
%每日光伏发电量
pvz=sdpvar(k,1,'full');

%实际清洁能源比例
ac=(sum(pvz)+sum(gtz))/(sum(ge)+sum(pvz)+sum(gtz));
%光伏发电总量
spvz=sum(pvz);
%燃气发电总量
sgtz=sum(gtz);
%买电总量
sge=sum(ge);

%定义自愈恢复率
R1=sdpvar(24,1,'full');
R2=sdpvar(24,1,'full');
R3=sdpvar(24,1,'full');
R4=sdpvar(24,1,'full');

%能完全恢复为1，不能为0
ce1=sdpvar(24,1,'full');
ce2=sdpvar(24,1,'full');
ce3=sdpvar(24,1,'full');
ce4=sdpvar(24,1,'full');

%通过0-1变量实现条件语句
d1=binvar(24,2,'full');
d2=binvar(24,2,'full');
d3=binvar(24,2,'full');
d4=binvar(24,2,'full');
d5=binvar(k,2,'full');

%定义电池状态
baz=sdpvar(k,1,'full');
cha=sdpvar(k,1,'full');
dis=sdpvar(k,1,'full');
baz(1,1)=0.2*ban;
baz(24,1)=0.2*ban;
baz(25,1)=0.2*ban;
baz(48,1)=0.2*ban;
baz(49,1)=0.2*ban;
baz(72,1)=0.2*ban;
baz(73,1)=0.2*ban;
baz(96,1)=0.2*ban;

%目标函数1：经济成本   （单位元）
 f1=815.14*1000*pvn+1091*1000*gtn+215.11*1000*ban+sum(gtz)*0.1975*2.86*91250+sum(ge'*data2)*91250;
 %目标函数2：碳排放 kg 
 f2=(sum(gtz)*0.4699+sum(ge)*0.8*0.8478)*91250;
 %目标函数3：恢复力 
 f3=(sum(ce1)+sum(ce2)+sum(ce3)+sum(ce4))/96;

 object=f1;

 %约束
 F=[];

%燃气轮机发电量小于额定容量
for i=1:k
    F=[F,gtz(i,1)-gtn*0.94<=0]; 
    F=[F,-gtz(i,1)<=0];
end

%燃气轮机爬坡速率(up，down)
for i=1:23
    F=[F,gtz(i+1,1)-gtz(i,1)<=0.3*gtn];
    F=[F,gtz(i,1)-gtz(i+1,1)-0.3*gtn<=0];
end

for i=25:47
    F=[F,gtz(i+1,1)-gtz(i,1)<=0.3*gtn];
    F=[F,gtz(i,1)-gtz(i+1,1)-0.3*gtn<=0;];
end

for i=49:71
    F=[F,gtz(i+1,1)-gtz(i,1)<=0.3*gtn];
    F=[F,gtz(i,1)-gtz(i+1,1)-0.3*gtn<=0];
end

for i=73:95
    F=[F,gtz(i+1,1)-gtz(i,1)<=0.3*gtn];
    F=[F,gtz(i,1)-gtz(i+1,1)-0.3*gtn<=0];
end

%购电
for i=1:k
    F=[F,-ge(i,1)<=0];
    F=[F,ge(i,1)-data1(i,1)<=0];
end

%每小时光伏发电
for i=1:k
    F=[F,pvz(i,1)==pvn*datapv(i,1)];
end

%电池充放电(要么充要么放)
for i = 1:96
    F = [F;sum(d5(i,:)) == 1;
        implies(d5(i,1),[cha(i,1) >=0.01, dis(i,1) == 0]);
        implies(d5(i,2),[dis(i,1) >=0.01, cha(i,1) == 0])];
end

%电池状态
for i=1:23
    F=[F,baz(i+1,1)==baz(i,1)*0.999+0.88*cha(i,1)-1.13*dis(i,1)];
end

for i=25:47
    F=[F,baz(i+1,1)==baz(i,1)*0.999+0.88*cha(i,1)-1.13*dis(i,1)];
end   

for i=49:71
    F=[F,baz(i+1,1)==baz(i,1)*0.999+0.88*cha(i,1)-1.13*dis(i,1)];
end

for i=73:95
    F=[F,baz(i+1,1)==baz(i,1)*0.999+0.88*cha(i,1)-1.13*dis(i,1)];
end

%定义充放电的上下限(按照最大三小时充放完)
for i=1:96
    F=[F,cha(i,1)<=0.33*ban];
    F=[F,-cha(i,1)<=0];
end

for i=1:96
    F=[F,dis(i,1)<=0.33*ban];
    F=[F,-dis(i,1)<=0];
end

%定义电池状态最大最小
for i=1:96
    F=[F,baz(i,1)<=0.95*ban];
    F=[F,-baz(i,1)<=0.2*ban];
end

%需求平衡
for i=1:k
    F=[F,pvz(i,1)+gtz(i,1)+ge(i,1)+dis(i,1)-data1(i,1)-cha(i,1)==0];
end

%自愈恢复率
for i=1:24
    F=[F,(ban+gtn*3)-R1(i,1)*(data3(i,1)+data3(i+1,1)+data3(i+2,1))==0];
    F=[F,(ban+gtn*3)-R2(i,1)*(data3(i,2)+data3(i+1,2)+data3(i+2,2))==0];
    F=[F,(ban+gtn*3)-R3(i,1)*(data3(i,3)+data3(i+1,3)+data3(i+2,3))==0];
    F=[F,(ban+gtn*3)-R4(i,1)*(data3(i,3)+data3(i+1,4)+data3(i+2,4))==0];
end


%判断是否能完全恢复电力
for i = 1:24
    F = [F;sum(d1(i,:)) == 1;
        implies(d1(i,1),[R1(i,1) <=0.99, ce1(i,1) == R1(i,1)]);
        implies(d1(i,2),[1-R1(i,1) <=0  , ce1(i,1) == 1])];
end

for i = 1:24
    F = [F;sum(d2(i,:)) == 1;
        implies(d2(i,1),[R2(i,1) <=0.99, ce2(i,1) == R2(i,1)]);
        implies(d2(i,2),[1-R2(i,1) <=0  , ce2(i,1) == 1])];
end

for i = 1:24
    F = [F;sum(d3(i,:)) == 1;
        implies(d3(i,1),[R3(i,1) <=0.99, ce3(i,1) == R3(i,1)]);
        implies(d3(i,2),[1-R3(i,1) <=0  , ce3(i,1) == 1])];
end

for i = 1:24
    F = [F;sum(d4(i,:)) == 1;
        implies(d4(i,1),[R4(i,1) <=0.99, ce4(i,1) == R4(i,1)]);
        implies(d4(i,2),[1-R4(i,1) <=0  , ce4(i,1) == 1])];
end  


%目标2碳排放
F=[F,(sum(gtz)*0.4699+sum(ge)*0.8*0.8478)*91250<=a*0.8*0.8478*288000000];

 %目标3恢复力改约束
F=[F,b*96-sum(ce1)-sum(ce2)-sum(ce3)-sum(ce4)<=0];

%约束2：储能安装限制
F=[F,0.1*pvn-ban<=0];
F=[F,ban-20<=0];

%约束3：数量安装限制
F=[F,-pvn<=0];
F=[F,-70+pvn<=0];

F=[F,-gtn<=0];
F=[F,-40+gtn<=0];
      
%约束4：满足当局分配    
 F=[F,y*(sum(ge)+sum(pvz)+sum(gtz))<=(sum(pvz)+sum(gtz))];
 
%gurbi求解器
ops = sdpsettings('solver','gurobi');
% ConstraintTolerance=10-9;
ops.intlinprog.TolInteger = 1e-06;
% options.TolInteger = 1e-07;
sol=solvesdp(F,object,ops);
object=double(object);

ge=double(ge);
gtz=double(gtz);
gtn=double(gtn);
ban=double(ban);
pvn=double(pvn);
f1=double(f1);
f2=double(f2);
f3=double(f3);
pvz=double(pvz);
ac=double(ac);
R1=double(R1);
R2=double(R2);
R3=double(R3);
R4=double(R4);
ce1=double(ce1);
ce2=double(ce2);
ce3=double(ce3);
ce4=double(ce4);
baz=double(baz);
cha=double(cha);
dis=double(dis);

